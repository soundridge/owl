# 产品需求文档：CLI Worktree 管理器

**版本**：1.0
**日期**：2026-01-30
**作者**：Sarah（产品负责人）
**质量评分**：92/100

---

## 执行摘要

这是一款面向单人开发者的桌面应用，用于在同一仓库中并行运行多个 CLI 编程代理（如 codex、claude code），同时避免相互覆盖与冲突。核心机制是为每个 session 创建独立的 git worktree，以隔离改动，并通过统一界面管理 workspace、session、终端与改动列表。

预期价值是显著降低并行 AI 编码的冲突风险与心理负担，让用户能快速开多个 agent、清晰看到各自改动，并在合适时机进行合并。

---

## 问题陈述

**现状**：多个 CLI agent 并行修改同一仓库时，容易发生改动覆盖、文件冲突和状态混乱。手动创建分支/worktree 与终端管理成本高、易出错。

**解决方案**：提供一个桌面 UI 来管理 workspace 与 session，为每个 session 自动创建 worktree，提供嵌入式终端，并展示该 session 的改动文件列表；同时提供合并入口，允许选择目标分支并执行 merge。

**业务影响**：提升并行 AI 编码的可控性与信心，减少冲突与误覆盖的风险。

---

## 成功指标

**主要指标：**
- 定性：用户能够在一个仓库中同时运行多个 CLI agent 而不担心冲突。
- 操作性：用户可在数次点击内创建/切换多个 session。

**验证方式**：用户自评与日常使用中的主观验证。

---

## 用户画像

### 主要用户：单人重度开发者
- **角色**：使用 AI 编码工具的开发者
- **目标**：多 agent 并行工作但互不干扰
- **痛点**：担心冲突与覆盖；手动 worktree/终端管理繁琐
- **技术水平**：高级

---

## 用户故事与验收标准

### 故事 1：管理 Workspace
**作为** 单人开发者
**我想要** 添加并管理 workspace（项目）
**以便** 在不同仓库间复用 session 工作流

**验收标准：**
- [ ] 用户可以选择本地 git 仓库路径添加 workspace
- [ ] workspace 列表可持久化保存
- [ ] 用户可移除 workspace 与其 session 元数据（不删除仓库本体）

### 故事 2：创建并使用 Session
**作为** 单人开发者
**我想要** 创建隔离的 session
**以便** 每个 agent 独立修改

**验收标准：**
- [ ] 创建 session 时基于当前分支创建新的 worktree
- [ ] 打开 session 时自动显示对应 worktree 的终端
- [ ] session 名称自动生成但可编辑
- [ ] 用户可关闭 session，并可选择删除对应 worktree

### 故事 3：查看 Session 改动
**作为** 单人开发者
**我想要** 查看 session 修改的文件
**以便** 确认改动隔离并保持可见性

**验收标准：**
- [ ] 右侧面板显示文件列表及状态（新增/修改/删除）
- [ ] 列表仅显示当前 session 的 worktree 改动
- [ ] git 状态变化时列表能更新

### 故事 4：合并入口
**作为** 单人开发者
**我想要** 将 session 合并到指定分支
**以便** 有意识地整合改动

**验收标准：**
- [ ] 用户可选择源（session 分支）与目标分支
- [ ] 确认后执行 `git merge`
- [ ] 明确报告合并结果（成功或冲突）

---

## 功能需求

### 核心功能

**功能 1：Workspace 管理**
- 描述：创建、列出与删除本地仓库 workspace
- 用户流程：
  1) 点击“添加 Workspace”并选择仓库路径
  2) 校验为 git 仓库
  3) workspace 出现在左侧列表
- 边界情况：
  - 选择了非 git 目录 → 提示错误
  - 仓库被移动/删除 → 显示警告并允许移除
- 错误处理：清晰错误提示 + 可重试

**功能 2：Session 管理（Worktree）**
- 描述：创建、打开、关闭、删除 session，并为其创建 worktree
- 用户流程：
  1) 选中 workspace 点击“新建 Session”
  2) 基于当前分支创建 worktree
  3) session 出现在列表中
  4) 打开 session 显示终端与文件列表
- 边界情况：
  - worktree 创建失败 → 提示错误且不创建 session
  - 删除 session 时存在 git 操作 → 弹窗阻止并确认
- 错误处理：可操作的错误信息与重试入口

**功能 3：嵌入式终端（xterm）**
- 描述：每个 session 对应一个 worktree 终端
- 用户流程：
  1) 打开 session
  2) 终端在 worktree 目录启动
  3) 用户手动运行 codex / claude code 等
- 边界情况：
  - shell 启动失败 → 显示错误并支持重试
- 错误处理：终端错误态 + 重试按钮

**功能 4：改动文件列表**
- 描述：右侧展示当前 session 的改动文件
- 用户流程：
  1) 在终端修改文件
  2) 应用通过 git status 获取改动
  3) 右侧更新文件列表
- 边界情况：
  - 大仓库性能波动 → 对刷新做防抖
- 错误处理：显示“无法读取 git 状态”并可重试

**功能 5：合并入口**
- 描述：将 session 分支合并到目标分支
- 用户流程：
  1) 点击“合并”
  2) 选择源分支与目标分支
  3) 确认后执行 merge
- 边界情况：
  - 发生冲突 → 提示冲突并停止（不自动解决）
  - 目标分支工作区不干净 → 阻止合并并提示清理
- 错误处理：显示命令结果摘要与后续建议

### 非目标范围
- 文件 diff 预览
- 文件内容查看
- Stage/unstage 操作
- 自动冲突解决
- 多人协作
- 远程仓库管理

---

## 技术约束

### 性能
- git 状态刷新对用户应接近实时（典型仓库 < 1s）
- git 操作不可阻塞 UI，需异步执行

### 安全
- 本地离线运行，不上传仓库内容

### 集成
- 依赖系统已安装 git CLI
- 终端使用 xterm.js + PTY 桥接

### 技术栈
- Electron + React + TypeScript（现有项目栈）
- xterm.js
- Node child_process 调用 git 命令

---

## MVP 范围与阶段规划

### Phase 1：MVP（首版必需）
- Workspace 创建/列表/删除
- Session 创建/打开/关闭/删除
- 每个 session 的嵌入式终端
- 当前 session 改动文件列表
- 合并入口（选择源/目标分支并执行 `git merge`）

**MVP 定义**：单人开发者可在一个仓库中并行开多个 session，各自运行 CLI agent，查看改动文件列表，并在需要时进行合并。

### Phase 2：增强
- 改动文件 diff 预览
- Session 备注与快照
- 合并冲突辅助 UI（不自动解决）

### 未来考虑
- Session 模板/预设
- Session 活动记录

---

## 风险评估

| 风险 | 概率 | 影响 | 缓解策略 |
|------|------|------|----------|
| git merge 冲突频繁 | 中 | 高 | 清晰冲突态与提示；不自动解决 |
| worktree 清理失败导致残留目录 | 中 | 中 | 记录路径并提供清理入口 |
| 大仓库导致状态刷新慢 | 中 | 中 | 防抖 + 手动刷新按钮 |

---

## 依赖与阻塞项

**依赖：**
- 系统已安装 git 并在 PATH 中可用
- Electron 下 PTY 兼容性

**已知阻塞项：**
- 暂无

---

## 附录

### 术语表
- **Workspace**：已注册的本地 git 仓库
- **Session**：基于 worktree 的工作单元
- **Worktree**：同一仓库的独立检出

### 参考
- 暂无

---

*本 PRD 通过交互式需求澄清与质量评估生成，以保证业务、功能、体验与技术维度覆盖完整。*
